<!DOCTYPE html>
<html>
<head>
  <title>Subreddit Graph Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/cytoscape@3.21.1/dist/cytoscape.min.js"></script>
  <style>
    #cy { width: 100%; height: 600px; border: 1px solid #ccc; margin-top: 20px; }
    input, button, datalist { margin: 5px; padding: 5px; }
    #loading {
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
    }
    .progress-bar {
      height: 5px;
      background: #4CAF50;
      width: 0%;
      transition: width 0.3s;
    }
  </style>
</head>
<body>

  <h3>Subreddit Graph Explorer</h3>
  <div id="loading">
    <div>Loading dataset... <span id="progress-text">0%</span></div>
    <div class="progress-bar" id="progress-bar"></div>
  </div>
  
  <input id="subInput" list="subList" placeholder="Enter subreddit name" disabled />
  <datalist id="subList"></datalist>
  <input id="depthInput" placeholder="Depth k (e.g., 2)" type="number" min="1" disabled />
  <input id="topKInput" placeholder="Top N edges (e.g., 10)" type="number" min="1" disabled />
  <button onclick="initGraph()" disabled id="generateBtn">Generate Graph</button>

  <div id="cy"></div>

  <script>
    let allEdges = [];
    let adjList = {};
    let allSubreddits = new Set();
    let isDataLoaded = false;

    // Show loading UI
    const loadingDiv = document.getElementById('loading');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    loadingDiv.style.display = 'block';

    // Stream CSV from GitHub LFS
    function streamCSV() {
      const csvUrl = "https://media.githubusercontent.com/media/RVNayan/RedditNetwork_Viz/refs/heads/main/data/JCSimilarity_Jaccard_cleaned.csv";
      let processedRows = 0;
      const estimatedTotalRows = 30000000; // Approximate for progress calculation

      Papa.parse(csvUrl, {
        download: true,
        header: true,
        chunk: function(results, parser) {
          // Process chunk of data
          for (const row of results.data) {
            if (!row.Source || !row.Target || !row.Weight) continue;

            const src = row.Source.trim();
            const tgt = row.Target.trim();
            const weight = parseFloat(row.Weight);

            if (!adjList[src]) adjList[src] = [];
            if (!adjList[tgt]) adjList[tgt] = [];

            adjList[src].push({ node: tgt, weight });
            adjList[tgt].push({ node: src, weight });

            allSubreddits.add(src);
            allSubreddits.add(tgt);
            processedRows++;
          }

          // Update progress
          const progress = Math.min(100, Math.round((processedRows / estimatedTotalRows) * 100));
          progressBar.style.width = `${progress}%`;
          progressText.textContent = `${progress}%`;

          // Early exit if we've processed enough (for testing)
          // if (processedRows > 100000) parser.abort();
        },
        complete: function() {
          loadingDiv.style.display = 'none';
          isDataLoaded = true;
          populateDatalist();
          enableUI();
          console.log("Dataset loaded with", allSubreddits.size, "subreddits");
        },
        error: function(err) {
          loadingDiv.innerHTML = `<p style="color:red">Error loading data: ${err.message}</p>`;
          console.error("CSV loading error:", err);
        }
      });
    }

    function enableUI() {
      document.getElementById("subInput").disabled = false;
      document.getElementById("depthInput").disabled = false;
      document.getElementById("topKInput").disabled = false;
      document.getElementById("generateBtn").disabled = false;
    }

    function populateDatalist() {
      const list = document.getElementById("subList");
      // Only show first 1000 for performance
      const subs = Array.from(allSubreddits).slice(0, 1000); 
      subs.forEach(sub => {
        const option = document.createElement("option");
        option.value = sub;
        list.appendChild(option);
      });
    }

    function initGraph() {
      if (!isDataLoaded) {
        alert("Data is still loading. Please wait...");
        return;
      }

      const start = document.getElementById("subInput").value.trim();
      const maxDepth = parseInt(document.getElementById("depthInput").value) || 1;
      const topK = parseInt(document.getElementById("topKInput").value) || 10;

      if (!adjList[start]) {
        alert(`Subreddit "${start}" not found. Try another one.`);
        return;
      }

      let visited = new Set([start]);
      let queue = [{ node: start, depth: 0 }];
      let elements = [{ data: { id: start, label: start } }];
      let addedEdges = new Set();

      while (queue.length > 0) {
        const { node, depth } = queue.shift();
        if (depth >= maxDepth) continue;

        const neighbors = (adjList[node] || [])
          .sort((a, b) => b.weight - a.weight)
          .slice(0, topK);

        for (const neighbor of neighbors) {
          const target = neighbor.node;
          const weight = neighbor.weight;

          const edgeId = `${node}__${target}`;
          const reverseEdgeId = `${target}__${node}`;
          if (!addedEdges.has(edgeId) && !addedEdges.has(reverseEdgeId)) {
            elements.push({
              data: {
                id: edgeId,
                source: node,
                target: target,
                weight: weight
              }
            });
            addedEdges.add(edgeId);
          }

          if (!visited.has(target)) {
            visited.add(target);
            queue.push({ node: target, depth: depth + 1 });
            elements.push({ data: { id: target, label: target } });
          }
        }
      }

      drawGraph(elements);
    }

    function drawGraph(elements) {
      const degreeMap = {};

      elements.forEach(el => {
        if (el.data.source && el.data.target) {
          degreeMap[el.data.source] = (degreeMap[el.data.source] || 0) + 1;
          degreeMap[el.data.target] = (degreeMap[el.data.target] || 0) + 1;
        }
      });

      const degrees = Object.values(degreeMap);
      const maxDeg = Math.max(...degrees);
      const minDeg = Math.min(...degrees);

      function getColor(deg) {
        const ratio = (deg - minDeg) / (maxDeg - minDeg || 1);
        const r = Math.round(255 * ratio);
        const b = Math.round(255 * (1 - ratio));
        return `rgb(${r}, 80, ${b})`;
      }

      elements.forEach(el => {
        if (el.data.label) {
          const deg = degreeMap[el.data.id] || 0;
          el.data.bgColor = getColor(deg);
        }
      });

      cytoscape({
        container: document.getElementById("cy"),
        elements: elements,
        layout: { 
          name: 'cose',
          idealEdgeLength: 100,
          nodeOverlap: 20,
          refresh: 20
        },
        style: [
          {
            selector: 'node',
            style: {
              label: 'data(label)',
              shape: 'rectangle',
              'font-size': '7px',
              'width': 'label',
              'height': 'label',
              'padding': '4px',
              'color': '#fff',
              'text-valign': 'center',
              'text-halign': 'center',
              'text-wrap': 'wrap',
              'background-color': 'data(bgColor)'
            }
          },
          {
            selector: 'edge',
            style: {
              width: 1,
              'line-color': '#aaa',
              'curve-style': 'bezier'
            }
          }
        ]
      });
    }

    // Start loading the data
    streamCSV();
  </script>
</body>
</html>