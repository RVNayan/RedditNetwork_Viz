<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RedditJ3 Graph Visualizer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #status {
      margin-top: 10px;
      font-weight: bold;
    }
    button, input {
      padding: 10px;
      font-size: 16px;
      margin-right: 10px;
    }
    #mynetwork {
      width: 100%;
      height: 600px;
      border: 1px solid lightgray;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<h1>RedditJ3 Graph Visualizer</h1>
<label for="name">Start Node:</label>
<input id="name" placeholder="e.g. r/technology" />
<label for="k">Top K:</label>
<input id="k" type="number" value="3" min="1" />
<label for="n">Levels:</label>
<input id="n" type="number" value="2" min="1" />
<button id="loadBtn">Load & Visualize</button>
<div id="status">Idle</div>
<div id="mynetwork"></div>

<script type="module">
  import { Network } from 'https://cdn.jsdelivr.net/npm/vis-network/standalone/esm/vis-network.min.js';

  const loadBtn = document.getElementById('loadBtn');
  const status = document.getElementById('status');

  const PARQUET_URL = 'https://huggingface.co/datasets/RVen/RedditJ3/resolve/main/filtered_output.parquet';

  let edgeData = [];

  loadBtn.addEventListener('click', async () => {
    const root = document.getElementById('name').value.trim();
    const k = parseInt(document.getElementById('k').value);
    const n = parseInt(document.getElementById('n').value);

    if (!root || isNaN(k) || isNaN(n)) {
      alert('Please fill all fields correctly.');
      return;
    }

    loadBtn.disabled = true;
    status.textContent = 'Loading parquet and building graph...';

    try {
      const { asyncBufferFromUrl, parquetReadObjects } = await import('https://cdn.jsdelivr.net/npm/hyparquet/src/hyparquet.min.js');
      const file = await asyncBufferFromUrl({ url: PARQUET_URL });
      const data = await parquetReadObjects({
        file,
        columns: ['Source', 'Target', 'Weight']
      });

      edgeData = data;
      status.textContent = `Loaded ${edgeData.length} edges. Building graph...`;
      const graph = buildGraph(edgeData);
      const subgraph = expandGraph(graph, root, k, n);
      drawGraph(subgraph);
      status.textContent = 'Graph loaded.';

    } catch (err) {
      console.error(err);
      status.textContent = 'Error: ' + err.message;
    } finally {
      loadBtn.disabled = false;
    }
  });

  function buildGraph(data) {
    const map = new Map();
    for (const { Source, Target, Weight } of data) {
      if (!map.has(Source)) map.set(Source, []);
      map.get(Source).push({ target: Target, weight: Weight });
    }
    return map;
  }

  function expandGraph(graph, start, k, depth) {
    const visited = new Set();
    const nodes = new Map();
    const edges = new Set();

    function dfs(node, level) {
      if (level > depth || visited.has(node)) return;
      visited.add(node);
      nodes.set(node, true);
      const neighbors = (graph.get(node) || [])
        .sort((a, b) => b.weight - a.weight)
        .slice(0, k);

      for (const { target, weight } of neighbors) {
        nodes.set(target, true);
        edges.add(`${node}|${target}|${weight}`);
        dfs(target, level + 1);
      }
    }

    dfs(start, 0);

    return {
      nodes: Array.from(nodes.keys()).map(id => ({ id, label: id })),
      edges: Array.from(edges).map(e => {
        const [from, to, weight] = e.split('|');
        return { from, to, label: false, width: Math.log10(parseFloat(weight) + 1) };
      })
    };
  }

  function drawGraph({ nodes, edges }) {
    const container = document.getElementById('mynetwork');
    const network = new Network(container, { nodes, edges }, {
      nodes: {
        shape: 'dot',
        size: 10
      },
      edges: {
        arrows: 'to',
        smooth: true
      },
      layout: {
        improvedLayout: true
      },
      physics: {
        stabilization: false
      }
    });
  }
</script>

</body>
</html>
